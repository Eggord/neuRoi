function hdl = importRawDataGui(hNr,varargin)
% Gui for importing raw data
% Multiple tab gui code adapted from TabDemo mathworks xxx
pa = inputParser;
addRequired(pa,'hNr',@(x) isa(x,'NrModel'))
addParameter(pa,'rawDataDir',pwd,@ischar);
addParameter(pa,'resultDir',pwd,@ischar);

parse(pa,hNr,varargin{:})
pr = pa.Results;


NumberOfTabs = 3;
%   Get user screen size
SC = get(0, 'ScreenSize');
MaxMonitorX = SC(3);
MaxMonitorY = SC(4);

%   Set the figure window size values
MainFigScaleX = .3;          % Change this value to adjust the
                             % figure size
MainFigScaleY = .6;          % Change this value to adjust the figure size
MaxWindowX = round(MaxMonitorX*MainFigScaleX);
MaxWindowY = round(MaxMonitorY*MainFigScaleY);
XBorder = (MaxMonitorX-MaxWindowX)/2;
YBorder = (MaxMonitorY-MaxWindowY)/2; 
TabOffset = 0;              % This value offsets the tabs inside the figure.
ButtonHeight = 40;
PanelWidth = MaxWindowX-2*TabOffset+4;
PanelHeight = MaxWindowY-ButtonHeight-2*TabOffset;
ButtonWidth = round((PanelWidth-NumberOfTabs)/NumberOfTabs);

 %   Set the color varables.  
 White = [1  1  1];            % White - Selected tab color     
 BGColor = .9*White;           % Light Grey - Background color


hdl.fig= figure('Position',[XBorder, YBorder, MaxWindowX, MaxWindowY]);

setappdata(hdl.fig,'hNr',pr.hNr)
setappdata(hdl.fig,'rawDataDir',pr.rawDataDir)

set(hdl.fig,'MenuBar','none');
set(hdl.fig,'ToolBar','none');
set(hdl.fig,'Name','Import Raw Data','NumberTitle','off');

%% Raw data tab
hdl.tabs{1} = uipanel('Units', 'pixels', ...
                'Visible', 'on', ...
                'Backgroundcolor', White, ...
                'BorderWidth',1, ...
                'Position', [TabOffset TabOffset ...
                PanelWidth PanelHeight]);

hdl.expTitleText = uicontrol(hdl.tabs{1},...
                             'Style','text',...
                             'String','Experiment information',...
                             'Tag','expTitle_text',...
                             'Position',[10 650 200 30]);

hdl.expNameText = uicontrol(hdl.tabs{1},...
                            'Style','text',...
                            'String','Experiment Name',...
                            'Tag','expName_text',...
                            'Position',[10 600 200 30]);

hdl.expNameEdit = uicontrol(hdl.tabs{1},...
                            'Style','edit',...
                            'String','new_experiment',...
                            'Tag','expName_edit',...
                            'Position',[180 600 300 25]);

hdl.frameRateText = uicontrol(hdl.tabs{1},...
                            'Style','text',...
                            'String','Frame Rate',...
                            'Tag','frameRate_text',...
                            'Position',[10 550 200 30]);

hdl.frameRateEdit = uicontrol(hdl.tabs{1},...
                            'Style','edit',...
                            'String','30',...
                            'Tag','frameRate_edit',...
                            'Position',[180 550 100 25]);

hdl.nPlaneText = uicontrol(hdl.tabs{1},...
                            'Style','text',...
                            'String','Number of planes',...
                            'Tag','nPlane_text',...
                            'Position',[10 500 200 30]);

hdl.nPlaneEdit = uicontrol(hdl.tabs{1},...
                            'Style','edit',...
                            'String','1',...
                            'Tag','nPlane_edit',...
                            'Position',[180 500 100 25]);

hdl.dataTitleText = uicontrol(hdl.tabs{1},...
                             'Style','text',...
                             'String','Raw data',...
                             'Tag','dataTitle_text',...
                             'Position',[10 450 200 30]);

hdl.rawDataDirText = uicontrol(hdl.tabs{1},...
                            'Style','text',...
                            'String','Raw data directory',...
                            'Tag','rawDataDir_text',...
                            'Position',[10 400 200 30]);

hdl.rawDataDirEdit = uicontrol(hdl.tabs{1},...
                               'Style','edit',...
                               'String',pr.rawDataDir,...
                               'Tag','rawDataDir_edit',...
                               'Position',[180 400 200 25]);

hdl.rawDataDirButton = uicontrol(hdl.tabs{1},...
                               'Style','pushbutton',...
                               'String','...',...
                               'Tag','rawDataDir_button',...
                               'Position',[390 400 100 25]);

hdl.fileListBox = uicontrol(hdl.tabs{1},...
                            'Style','listbox',...
                            'Tag','fileListBox',...
                            'Max',20,...
                            'Position',[200 175 300 200],...
                            'FontSize',16);

hdl.removeFileButton =  uicontrol(hdl.tabs{1},...
                                  'Style','pushbutton',...
                                  'String','-',...
                                  'Tag','rawDataDir_button',...
                                  'Position',[400   150   70    25],...
                                  'FontSize',20);

hdl.rawDataDirText = uicontrol(hdl.tabs{1},...
                            'Style','text',...
                            'String','Result directory',...
                            'Tag','resultDir_text',...
                            'Position',[10 100 200 30]);


hdl.resultDirEdit = uicontrol(hdl.tabs{1},...
                               'Style','edit',...
                               'String',pr.resultDir,...
                               'Tag','resultDir_edit',...
                               'Position',[180 100 200 25]);

hdl.resultDirButton = uicontrol(hdl.tabs{1},...
                               'Style','pushbutton',...
                               'String','...',...
                               'Tag','resultDir_button',...
                               'Position',[390 100 100 25]);


hdl.importButton = uicontrol(hdl.tabs{1},...
                             'String','Import',...
                             'Tag','import_button',...
                             'Position',[10 10 100 35]);

updateFileList(hdl.fig,pr.rawDataDir)

%% Motion correction tab
hdl.tabs{2} = uipanel('Units', 'pixels', ...
                'Visible', 'off', ...
                'Backgroundcolor', White, ...
                'BorderWidth',1, ...
                'Position', [TabOffset TabOffset ...
                PanelWidth PanelHeight]);


set(hdl.importButton,'Callback',@import_Callback)
set(hdl.rawDataDirButton,'Callback',@rawDataDirButton_Callback)
set(hdl.rawDataDirEdit,'Callback',@rawDataDirEdit_Callback)
set(hdl.removeFileButton,'Callback',@removeFileButton_Callback)

setappdata(hdl.fig,'guiHdl',hdl)


function switchTab(hfig,tabIdx)
hdl = getappdata(hfig,'guiHdl');
for k = 1:length(hdl.tabs)
    set(hdl.tabs{k}, 'Visible', 'off');
end
set(hdl.tabs{tabIdx}, 'Visible', 'on');
            

function import_Callback(src,event)
hfig = ancestor(src,'figure');%src.Parent;
expInfo.name = get(findobj(hfig,'Tag','expName_edit'),'String');
expInfo.frameRate = str2num(get(findobj(hfig,'Tag','frameRate_edit'),'String'));
expInfo.nPlane = str2num(get(findobj(hfig,'Tag','nPlane_edit'), ...
                             'String'));

rawDataDir = get(findobj(hfig,'Tag','rawDataDir_edit'),'String');
fileListBox = findobj(hfig,'Tag','fileListBox');
rawFileList = fileListBox.String;
resultDir = get(findobj(hfig,'Tag','resultDir_edit'),'String');
hNr = getappdata(hfig,'hNr');
hNr.importRawData(expInfo,rawDataDir,rawFileList,resultDir);
switchTab(hfig,2)


function rawDataDirButton_Callback(src,event)
hfig = ancestor(src,'figure');
rawDataDir = getappdata(hfig,'rawDataDir');
rawDataDir = uigetdir(rawDataDir,'Choose raw data directory');
if rawDataDir
    set(findobj(hfig,'Tag','rawDataDir_edit'),'String',rawDataDir);
    setappdata(hfig,'rawDataDir',rawDataDir)
    updateFileList(hfig,rawDataDir);
end

function rawDataDirEdit_Callback(src,event)
hfig = ancestor(src,'figure');
rawDataDir = src.String;
setappdata(hfig,'rawDataDir',rawDataDir)
updateFileList(hfig,rawDataDir);

function updateFileList(hfig,rawDataDir)
if exist(rawDataDir,'dir')
    rawFileList = dir(fullfile(rawDataDir,'*.tif'));
    rawFileList = arrayfun(@(x) x.name, rawFileList,'UniformOutput',false);
    fileListBox = findobj(hfig,'Tag','fileListBox');
    set(fileListBox,'String',rawFileList);
else
    error('Raw data directory not found!')
end

function removeFileButton_Callback(src,event)
hfig = ancestor(src,'figure');
fileListBox = findobj(hfig,'Tag','fileListBox');
selectedIdx = get(fileListBox,'Value');
currentItems = get(fileListBox, 'String');
newItems = currentItems;
newItems(selectedIdx) = [];
set(fileListBox,'Value',[]);
set(fileListBox, 'String', newItems);

% Filter
